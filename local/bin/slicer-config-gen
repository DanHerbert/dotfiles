#!/bin/bash
set -eux

# Printer configs are intentionally not generated by this script. Those configs
# have certain associations that don't seem to inherit the same as
# print/filament configs and would cause more problems than they resolve.

script_file="$(readlink -f "${BASH_SOURCE[0]}")"
real_script_dir=$( cd -- "$( dirname -- "$script_file" )" &> /dev/null && pwd )
dotfiles_root="$real_script_dir/../.."

lib_dir="$dotfiles_root/lib/PrusaSlicer"
vendor_dir=$XDG_CONFIG_HOME/PrusaSlicer/vendor
prusa_ini_path=$vendor_dir/PrusaResearch.ini
base_config_path="$lib_dir/prusa_base_configs.txt"

{
    printf '\n\n'
    sed -n '/^\[print\:\*common\*\]/,/^\[/p' "$prusa_ini_path" | head -n-1
    sed -n '/^\[print\:\*MK3\*\]/,/^\[/p' "$prusa_ini_path" | head -n-1
    sed -n '/^\[print\:\*0.07mm\*\]/,/^\[/p' "$prusa_ini_path" | head -n-1
    sed -n '/^\[print\:\*0.10mm\*\]/,/^\[/p' "$prusa_ini_path" | head -n-1
    sed -n '/^\[print\:\*0.15mm\*\]/,/^\[/p' "$prusa_ini_path" | head -n-1
    sed -n '/^\[print\:\*0.20mm\*\]/,/^\[/p' "$prusa_ini_path" | head -n-1
    echo '[print:*0.07mm_ULTRADETAIL_@MK3*]'
    sed -n '/^\[print\:0.07mm ULTRADETAIL \@MK3\]/,/^\[/p' "$prusa_ini_path" | tail -n+2 | head -n-1
    echo '[print:*0.10mm_DETAIL_@MK3*]'
    sed -n '/^\[print\:0.10mm DETAIL \@MK3\]/,/^\[/p' "$prusa_ini_path" | tail -n+2 | head -n-1
    echo '[print:*0.15mm_QUALITY_@MK3*]'
    sed -n '/^\[print\:0.15mm QUALITY \@MK3\]/,/^\[/p' "$prusa_ini_path" | tail -n+2 | head -n-1
    echo '[print:*0.20mm_QUALITY_@MK3*]'
    sed -n '/^\[print\:0.20mm QUALITY \@MK3\]/,/^\[/p' "$prusa_ini_path" | tail -n+2 | head -n-1
    echo '[print:*0.15mm_SPEED_@MK3*]'
    sed -n '/^\[print\:0.15mm SPEED \@MK3\]/,/^\[/p' "$prusa_ini_path" | tail -n+2 | head -n-1
    echo '[print:*0.20mm_SPEED_@MK3*]'
    sed -n '/^\[print\:0.20mm SPEED \@MK3\]/,/^\[/p' "$prusa_ini_path" | tail -n+2 | head -n-1
    printf '\n\n'

    sed -n '/^\[filament\:\*common\*\]/,/^\[/p' "$prusa_ini_path" | head -n-1
    sed -n '/^\[filament\:\*PLA\*\]/,/^\[/p' "$prusa_ini_path" | head -n-1
    sed -n '/^\[filament\:\*PET\*\]/,/^\[/p' "$prusa_ini_path" | head -n-1
    echo '[filament:*Generic_PLA*]'
    sed -n '/^\[filament\:Generic PLA\]/,/^\[/p' "$prusa_ini_path" | tail -n+2 | head -n-1
    echo '[filament:*Generic_PETG*]'
    sed -n '/^\[filament\:Generic PETG\]/,/^\[/p' "$prusa_ini_path" | tail -n+2 | head -n-1
    printf '\n\n'

} > "$base_config_path"

cat "$lib_dir/HerbertResearchHeading.txt" "$base_config_path" "$lib_dir/HerbertResearchBody.ini" > "$lib_dir/HerbertResearch.ini"
rm "$base_config_path"
set +x
echo 'Config written to '"$(realpath "$lib_dir/HerbertResearch.ini")"

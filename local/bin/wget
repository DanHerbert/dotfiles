#!/bin/sh
# wget wrapper which ensures the hsts file gets written to the proper XDG
# location. This could get called by other scripts, so it is intentionally
# overcautious about every variable and executable which may get used.

SCRIPT_DIR=$(CDPATH='' cd -- "$(dirname -- "$0")" && pwd)
SCRIPT_OWNER=$(stat -c "%U" "$SCRIPT_DIR")

modified_path=":$PATH:"
while [ "${modified_path#*":$SCRIPT_DIR:"}" != "$modified_path" ]; do
    modified_path=":$modified_path:"
    modified_path="$(echo "$modified_path" | sed "s|:$SCRIPT_DIR:|:|")"
done
real_wget="$(PATH="$modified_path" command -v wget 2>/dev/null)"
if [ -z "${real_wget}" ]; then
    shell_name="$(basename "${SHELL}")"
    prefix="$(test -n "${shell_name}" && echo "${shell_name}: ")"
    echo "${prefix}command not found: wget" >&2
    exit 1
fi
HOME="${HOME:-$(eval echo "~${USER:-$SCRIPT_OWNER}")}"
XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-${HOME}/.config}"
if [ ! -e "${XDG_CONFIG_HOME}/wget/wget-hsts.txt" ]; then
    mkdir -p "${XDG_CONFIG_HOME}/wget"
    touch "${XDG_CONFIG_HOME}/wget/wget-hsts.txt"
fi

"${real_wget}" --hsts-file="${XDG_CONFIG_HOME}/wget/wget-hsts.txt" "$@"
